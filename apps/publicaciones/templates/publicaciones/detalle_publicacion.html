{% extends 'base.html' %} 

{% block titulo %}{{ publicacion.titulo }}{% endblock titulo %}

{% block contenido %}

    <article>
        <h2>{{ publicacion.titulo }}</h2>
        
        <p>
            CategorÃ­a: <b>{{ publicacion.categoria }}</b> | 
            Autor: <b>{{ publicacion.autor }}</b> | 
            Publicado el: {{ publicacion.fecha_creacion|date:"d M Y" }}
        </p>

        <hr>

        <p>{{ publicacion.contenido }}</p>

        <hr>

        {# LÃ“GICA DE EDICIÃ“N: El botÃ³n solo aparece si el usuario logueado es el autor #}
        {# Actualmente solo verifica que el usuario logueado sea el autor (funcional con el test_func) #}
        {% if user.is_authenticated and user == publicacion.autor %}
            <p>
                {# Usamos la URL 'publicaciones:editar' que definimos en urls.py #}
                <a href="{% url 'publicaciones:editar' pk=publicacion.pk %}">
                    <button>Editar PublicaciÃ³n</button>
                </a>
            </p>
        {% endif %}

    </article>

    <hr>
    
    {# ðŸš¨ CORRECCIÃ“N 1: Usar la variable 'comentarios' pasada desde la vista (ya filtrada) #}
    <h3 class="mt-4">Comentarios ({{ comentarios|length }})</h3>
    
    {% for comentario in comentarios %}
        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
            <p>
                <strong>{{ comentario.autor.username }}</strong> dice:
                <small style="float: right;">{{ comentario.fecha_creacion|date:"d M Y H:i" }}</small>
            </p>
            <p>{{ comentario.contenido }}</p>
            
            {# LÃ“GICA DE EDICIÃ“N/ELIMINACIÃ“N DE COMENTARIO #}
            {% if user.is_superuser or user.is_authenticated and user == comentarios.autor %}
                <small>
                    <a href="{% url 'comentarios:editar' comentario.pk %}">Editar</a> |
                    <a href="{% url 'comentarios:eliminar' comentario.pk %}">Eliminar</a>
                </small>
            {% endif %}
        </div>
    {% empty %}
        <p>SÃ© el primero en comentar.</p>
    {% endfor %}

    <hr>

    {# ðŸš¨ CORRECCIÃ“N 2: Usar 'comentario_form' y enviar a la misma URL ðŸš¨ #}
    {% if user.is_authenticated and comentario_form %}
        <h4>Deja tu comentario</h4>
        <form method="post">
            {% csrf_token %}
            
            {# El comentario tiene el nombre de 'comentario_form' en la vista (publicacion/views.py) #}
            {{ comentario_form.as_p }} 
            
            <button type="submit">Enviar Comentario</button>
        </form>
    {% else %}
        <p>Debes <a href="{% url 'login' %}">iniciar sesiÃ³n</a> para comentar.</p>
    {% endif %}

{% endblock contenido %}